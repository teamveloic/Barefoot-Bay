<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barefoot Bay Analytics Dashboard</title>
  <!-- Add Tailwind CSS for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Maps API loaded dynamically -->
  <script>
    // Get Google Maps API key from environment variable
    function loadGoogleMapsApi() {
      // Create script tag dynamically
      const script = document.createElement('script');
      
      // The server will replace this with the actual API key from environment
      script.src = 'https://maps.googleapis.com/maps/api/js?key=' + 
                   (window.GOOGLE_MAPS_API_KEY || '') + '&libraries=visualization';
      script.async = true;
      script.defer = true;
      script.onerror = function() {
        console.error('Failed to load Google Maps API');
        // Handle maps failure
        document.getElementById('map').innerHTML = 
          '<div class="flex items-center justify-center h-full bg-gray-100 rounded">' +
          '<p class="text-gray-500">Geographic map could not be loaded</p>' + 
          '</div>';
      };
      document.head.appendChild(script);
    }
    
    // We'll call this function after the page loads
  </script>
  <!-- Chart.js for data visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .card {
      @apply bg-white rounded-lg shadow-md p-5;
    }
    .metric-card {
      @apply flex flex-col justify-between h-full;
    }
    .metric-value {
      @apply text-4xl font-bold text-teal-700;
    }
    .metric-label {
      @apply text-gray-500 text-sm mt-2;
    }
    .progress-bar {
      @apply h-2 bg-gray-200 rounded-full mt-2 overflow-hidden;
    }
    .progress-value {
      @apply h-full bg-teal-600 rounded-full;
    }
    #map {
      height: 300px;
      width: 100%;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-6">
    <header class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-teal-700">Analytics Dashboard</h1>
      <div class="flex items-center gap-4">
        <span id="username" class="text-gray-600">User</span>
        <span id="role" class="bg-teal-600 text-white px-3 py-1 rounded-full text-sm">Admin</span>
      </div>
    </header>

    <!-- Date Range Filter -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6 flex flex-wrap items-center gap-4">
      <div class="flex items-center">
        <label for="fromDate" class="mr-2 text-gray-600">From:</label>
        <input type="date" id="fromDate" class="border rounded p-2">
      </div>
      <div class="flex items-center">
        <label for="toDate" class="mr-2 text-gray-600">To:</label>
        <input type="date" id="toDate" class="border rounded p-2">
      </div>
      <button id="applyDates" class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">Apply</button>
      
      <div class="flex gap-2 ml-auto">
        <button class="date-preset bg-gray-200 text-gray-700 px-3 py-2 rounded hover:bg-gray-300" data-days="1">Today</button>
        <button class="date-preset bg-teal-600 text-white px-3 py-2 rounded hover:bg-teal-700" data-days="30">Last 30 Days</button>
        <button class="date-preset bg-gray-200 text-gray-700 px-3 py-2 rounded hover:bg-gray-300" data-days="7">Last 7 Days</button>
        <button class="date-preset bg-gray-200 text-gray-700 px-3 py-2 rounded hover:bg-gray-300" data-days="90">Last 90 Days</button>
        <button class="date-preset bg-gray-200 text-gray-700 px-3 py-2 rounded hover:bg-gray-300" data-days="365">Last Year</button>
      </div>
    </div>

    <!-- Key Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <!-- Total Sessions -->
      <div class="card metric-card">
        <div>
          <h2 class="text-lg font-semibold text-gray-700">Total Sessions</h2>
          <p id="totalSessions" class="metric-value">--</p>
        </div>
        <p id="totalSessionsLabel" class="metric-label">Last 30 days</p>
      </div>
      
      <!-- Unique Users -->
      <div class="card metric-card">
        <div>
          <h2 class="text-lg font-semibold text-gray-700">Unique Users</h2>
          <p id="uniqueUsers" class="metric-value">--</p>
        </div>
        <p id="uniqueUsersLabel" class="metric-label">Last 30 days</p>
      </div>
      
      <!-- Average Session Duration -->
      <div class="card metric-card">
        <div>
          <h2 class="text-lg font-semibold text-gray-700">Avg. Session Duration</h2>
          <p id="avgSessionDuration" class="metric-value">--</p>
        </div>
        <p id="avgSessionLabel" class="metric-label">In minutes</p>
      </div>
    </div>

    <!-- Traffic Trend Chart -->
    <div class="grid grid-cols-1 gap-6 mb-6">
      <div class="card">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Daily Traffic</h2>
        <canvas id="trafficTrendChart" height="100"></canvas>
      </div>
    </div>
    
    <!-- Real-Time Active Users -->
    <div class="grid grid-cols-1 gap-6 mb-6">
      <div class="card">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Real-Time Active Users</h2>
        <div class="flex flex-col items-center mb-6">
          <p id="activeUserCount" class="text-5xl font-bold text-teal-700">0</p>
          <p class="text-gray-500 text-sm mt-2">active now</p>
        </div>
        <div class="overflow-auto">
          <table class="w-full">
            <thead class="border-b">
              <tr>
                <th class="text-left pb-2">User</th>
                <th class="text-left pb-2">Current Page</th>
                <th class="text-right pb-2">Last Activity</th>
              </tr>
            </thead>
            <tbody id="activeUsers">
              <!-- Active user data will be inserted here -->
              <tr><td colspan="3" class="text-center py-4" id="noActiveUsersMsg">No active users currently.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- User Journey Visualization -->
    <div class="grid grid-cols-1 gap-6 mb-6">
      <div class="card">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">User Journey Visualization</h2>
        <div class="flex mb-4 border-b">
          <button id="pathTransitionsBtn" class="tab-button active px-4 py-2">Path Transitions</button>
          <button id="entryPagesBtn" class="tab-button px-4 py-2">Entry Pages</button>
          <button id="exitPagesBtn" class="tab-button px-4 py-2">Exit Pages</button>
        </div>
        <div id="userJourneyContainer" class="min-h-[200px] flex items-center justify-center">
          <p id="noJourneyDataMsg">No user journey data available yet.</p>
          <div id="userJourneyVisualization" class="w-full hidden"></div>
        </div>
      </div>
    </div>

    <!-- Detailed Data -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <!-- Top Pages -->
      <div class="card lg:col-span-1">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Top Pages</h2>
        <div class="overflow-auto max-h-96">
          <table class="w-full">
            <thead class="border-b">
              <tr>
                <th class="text-left pb-2">Page Path</th>
                <th class="text-right pb-2">Views</th>
                <th class="text-right pb-2">% of Total</th>
              </tr>
            </thead>
            <tbody id="topPages">
              <!-- Top pages will be inserted here -->
              <tr><td colspan="3" class="text-center py-4">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Geolocation Map -->
      <div class="card lg:col-span-2">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Geographic Distribution</h2>
        <div id="map"></div>
      </div>
    </div>

    <!-- Traffic Sources and Device Info -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <!-- Traffic Sources -->
      <div class="card">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Traffic Sources</h2>
        <canvas id="trafficSourcesChart" height="200"></canvas>
      </div>
      
      <!-- Device Types -->
      <div class="card">
        <h2 class="text-lg font-semibold text-teal-700 mb-4">Device Types</h2>
        <div id="deviceTypes">
          <!-- Device type bars will be inserted here -->
          <div class="my-4">
            <div class="flex items-center justify-between bg-gray-100 px-3 py-2 rounded">
              <span class="text-gray-700">Desktop</span>
              <span class="font-medium">3 (75.0%)</span>
            </div>
            <div class="progress-bar mt-1">
              <div class="progress-value bg-teal-700" style="width: 75%"></div>
            </div>
          </div>
          <div class="my-4">
            <div class="flex items-center justify-between bg-gray-100 px-3 py-2 rounded">
              <span class="text-gray-700">Mobile</span>
              <span class="font-medium">1 (25.0%)</span>
            </div>
            <div class="progress-bar mt-1">
              <div class="progress-value bg-teal-700" style="width: 25%"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Browsers -->
      <div class="card">
        <h2 class="text-lg font-semibold text-teal-700 mb-4">Browsers</h2>
        <div id="browsers">
          <!-- Browser type bars will be inserted here -->
          <div class="my-4">
            <div class="flex items-center justify-between bg-gray-100 px-3 py-2 rounded">
              <span class="text-gray-700">Chrome</span>
              <span class="font-medium">3 (75.0%)</span>
            </div>
            <div class="progress-bar mt-1">
              <div class="progress-value bg-teal-700" style="width: 75%"></div>
            </div>
          </div>
          <div class="my-4">
            <div class="flex items-center justify-between bg-gray-100 px-3 py-2 rounded">
              <span class="text-gray-700">Safari</span>
              <span class="font-medium">1 (25.0%)</span>
            </div>
            <div class="progress-bar mt-1">
              <div class="progress-value bg-teal-700" style="width: 25%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Referrers Table -->
    <div class="grid grid-cols-1 gap-6 mb-6">
      <div class="card">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Top Referrers</h2>
        <div class="overflow-auto">
          <table class="w-full">
            <thead class="border-b">
              <tr>
                <th class="text-left pb-2">Source</th>
                <th class="text-right pb-2">Sessions</th>
              </tr>
            </thead>
            <tbody id="topReferrers">
              <!-- Referrer data will be inserted here -->
              <tr><td colspan="2" class="text-center py-4">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Current date range
    let currentRange = 30; // Default to 30 days
    let trafficTrendChart = null;
    let trafficSourcesChart = null;
    let map = null;
    let heatmap = null;

    // Get user info
    function getUserInfo() {
      fetch('/api/user')
        .then(response => {
          if (response.ok) return response.json();
          return null;
        })
        .then(user => {
          if (user) {
            document.getElementById('username').textContent = user.fullName || user.username;
            document.getElementById('role').textContent = user.role;
          }
        })
        .catch(error => {
          console.error('Error fetching user info:', error);
        });
    }

    // Format numbers with commas
    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // Format seconds to minutes and seconds
    function formatDuration(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return `${minutes}.${remainingSeconds.toString().padStart(2, '0')}`;
    }

    // Update the date presets based on current selection
    function updateDatePresets(selectedDays) {
      document.querySelectorAll('.date-preset').forEach(btn => {
        const days = parseInt(btn.dataset.days);
        if (days === selectedDays) {
          btn.classList.remove('bg-gray-200', 'text-gray-700');
          btn.classList.add('bg-teal-600', 'text-white');
        } else {
          btn.classList.remove('bg-teal-600', 'text-white');
          btn.classList.add('bg-gray-200', 'text-gray-700');
        }
      });
    }

    // Fetch analytics data from API
    function fetchAnalyticsData(range = 30) {
      console.log(`Fetching analytics data for range: ${range}`);
      
      // Show loading state
      document.getElementById('totalSessions').textContent = '...';
      document.getElementById('uniqueUsers').textContent = '...';
      document.getElementById('avgSessionDuration').textContent = '...';
      
      // Tables loading state
      document.getElementById('topPages').innerHTML = `
        <tr><td colspan="3" class="text-center py-4">Loading data...</td></tr>
      `;
      document.getElementById('topReferrers').innerHTML = `
        <tr><td colspan="2" class="text-center py-4">Loading data...</td></tr>
      `;
      
      fetch(`/api/analytics/public?range=${range}&liveDataOnly=true`)
        .then(response => {
          console.log('API response status:', response.status);
          if (!response.ok) {
            throw new Error(`API responded with status: ${response.status}`);
          }
          return response.json();
        })
        .then(result => {
          console.log('API data received:', result);
          if (result.success && result.data) {
            const data = result.data;
            
            // Check if we have actual data
            const hasMetrics = data.metrics && 
                              (data.metrics.pageViews > 0 || 
                               data.metrics.uniqueVisitors > 0);
            
            if (hasMetrics) {
              updateDashboard(data);
              currentRange = range;
              updateDatePresets(range);
              updateDateLabels(range);
            } else {
              // Handle case where API returns success but no actual data
              handleNoData();
            }
          } else {
            console.error('API returned success: false or no data');
            // Show error state
            handleApiError(new Error('No data returned from API'));
          }
        })
        .catch(error => {
          console.error('Error fetching analytics data:', error);
          // Show error state
          handleApiError(error);
        });
    }
    
    // Handle case when API call fails
    function handleApiError(error) {
      console.error('API error:', error);
      
      // Show error state in the dashboard
      document.getElementById('totalSessions').textContent = '--';
      document.getElementById('uniqueUsers').textContent = '--';
      document.getElementById('avgSessionDuration').textContent = '--';
      
      // Clear tables with error messages
      document.getElementById('topPages').innerHTML = `
        <tr><td colspan="3" class="text-center py-4 text-red-500">
          Error loading data. Please try again later.
        </td></tr>
      `;
      
      document.getElementById('topReferrers').innerHTML = `
        <tr><td colspan="2" class="text-center py-4 text-red-500">
          Error loading data. Please try again later.
        </td></tr>
      `;
      
      // Show error in charts
      if (trafficTrendChart) {
        trafficTrendChart.destroy();
        trafficTrendChart = null;
      }
      if (trafficSourcesChart) {
        trafficSourcesChart.destroy();
        trafficSourcesChart = null;
      }
      
      // Show error in map
      document.getElementById('map').innerHTML = `
        <div class="flex items-center justify-center h-full bg-gray-100 rounded">
          <p class="text-red-500">Error loading geographic data</p>
        </div>
      `;
      
      // Show error in device types and browsers
      document.getElementById('deviceTypes').innerHTML = `
        <div class="py-4 text-center text-red-500">
          Error loading device data
        </div>
      `;
      
      document.getElementById('browsers').innerHTML = `
        <div class="py-4 text-center text-red-500">
          Error loading browser data
        </div>
      `;
    }
    
    // Handle case when no data is available
    function handleNoData() {
      console.log('No analytics data available');
      
      // Show empty state in the dashboard
      document.getElementById('totalSessions').textContent = '0';
      document.getElementById('uniqueUsers').textContent = '0';
      document.getElementById('avgSessionDuration').textContent = '0';
      
      // Clear tables with empty messages
      document.getElementById('topPages').innerHTML = `
        <tr><td colspan="3" class="text-center py-4 text-gray-500">
          No page view data available yet
        </td></tr>
      `;
      
      document.getElementById('topReferrers').innerHTML = `
        <tr><td colspan="2" class="text-center py-4 text-gray-500">
          No referrer data available yet
        </td></tr>
      `;
      
      // Show empty charts
      if (trafficTrendChart) {
        trafficTrendChart.destroy();
        trafficTrendChart = null;
      }
      if (trafficSourcesChart) {
        trafficSourcesChart.destroy();
        trafficSourcesChart = null;
      }
      
      // Show empty map
      document.getElementById('map').innerHTML = `
        <div class="flex items-center justify-center h-full bg-gray-100 rounded">
          <p class="text-gray-500">No geographic data available yet</p>
        </div>
      `;
      
      // Show empty device types and browsers
      document.getElementById('deviceTypes').innerHTML = `
        <div class="py-4 text-center text-gray-500">
          No device data available yet
        </div>
      `;
      
      document.getElementById('browsers').innerHTML = `
        <div class="py-4 text-center text-gray-500">
          No browser data available yet
        </div>
      `;
    }

    // Update dashboard with data
    function updateDashboard(data) {
      try {
        console.log("Updating dashboard with data:", data);
        
        // Update key metrics 
        document.getElementById('totalSessions').textContent = formatNumber(data.metrics.totalSessions);
        document.getElementById('uniqueUsers').textContent = formatNumber(data.metrics.uniqueVisitors);
        document.getElementById('avgSessionDuration').textContent = formatDuration(data.metrics.avgSessionDuration);
        
        // Update top pages table if available
        if (data.topPages && Array.isArray(data.topPages)) {
          updateTopPagesTable(data.topPages);
        } else {
          document.getElementById('topPages').innerHTML = 
            '<tr><td colspan="3" class="text-center py-4">No page data available</td></tr>';
        }
        
        // Update traffic sources chart if available
        if (data.referrers && Array.isArray(data.referrers)) {
          updateTrafficSourcesChart(data.referrers);
        } else {
          // Handle empty data case
          document.getElementById('trafficSourcesChart').getContext('2d').clearRect(0, 0, 
            document.getElementById('trafficSourcesChart').width, 
            document.getElementById('trafficSourcesChart').height);
        }
        
        // Update geographical distribution if available
        if (data.geoData && data.geoData.locations && Array.isArray(data.geoData.locations)) {
          updateGeoMap(data.geoData.locations);
        }
        
        // Update traffic trend chart with daily visitor data
        if (data.dailyVisitors && Array.isArray(data.dailyVisitors)) {
          updateTrafficTrendChart(data.dailyVisitors);
        }
        
        // Update user journey visualizations if data is available
        if (data.userJourneys) {
          if (window.updateJourneyData) {
            window.updateJourneyData(data.userJourneys);
          }
        }
        
        // Process device types to match expected format
        if (data.devices && Array.isArray(data.devices)) {
          const totalDevices = data.devices.reduce((sum, device) => sum + device.count, 0);
          const deviceData = data.devices.map(device => ({
            name: device.name,
            count: device.count,
            value: totalDevices > 0 ? (device.count / totalDevices * 100) : 0
          }));
          updateDeviceTypes(deviceData);
        } else {
          document.getElementById('deviceTypes').innerHTML = 
            '<div class="text-center py-4">No device data available</div>';
        }
        
        // Process browser data to match expected format
        if (data.browsers && Array.isArray(data.browsers)) {
          const totalBrowsers = data.browsers.reduce((sum, browser) => sum + browser.count, 0);
          const browserData = data.browsers.map(browser => ({
            name: browser.name,
            count: browser.count,
            value: totalBrowsers > 0 ? (browser.count / totalBrowsers * 100) : 0
          }));
          updateBrowsers(browserData);
        } else {
          document.getElementById('browsers').innerHTML = 
            '<div class="text-center py-4">No browser data available</div>';
        }
        
        // Update referrers
        if (data.referrers && Array.isArray(data.referrers)) {
          updateReferrers(data.referrers.map(ref => ({
            name: ref.name,
            sessions: ref.count
          })));
        } else {
          document.getElementById('topReferrers').innerHTML = 
            '<tr><td colspan="2" class="text-center py-4">No referrer data available</td></tr>';
        }
      } catch (error) {
        console.error("Error updating dashboard:", error);
        // Show error state in UI
        document.getElementById('totalSessions').textContent = '--';
        document.getElementById('uniqueUsers').textContent = '--';
        document.getElementById('avgSessionDuration').textContent = '--';
      }
    }

    // Update top pages table
    function updateTopPagesTable(pages) {
      const totalViews = pages.reduce((sum, page) => sum + page.views, 0);
      const tableBody = document.getElementById('topPages');
      tableBody.innerHTML = '';
      
      pages.forEach(page => {
        const percentage = (page.views / totalViews * 100).toFixed(1);
        const row = document.createElement('tr');
        row.classList.add('border-b', 'border-gray-100');
        
        // Use either path or url depending on what's available in the data
        const pagePath = page.path || page.url || 'Unknown Page';
        
        row.innerHTML = `
          <td class="py-3">
            <div class="font-medium">${page.title || 'Untitled Page'}</div>
            <div class="text-xs text-gray-500">${pagePath}</div>
          </td>
          <td class="text-right py-3">${formatNumber(page.views)}</td>
          <td class="text-right py-3">
            ${percentage}%
            <div class="progress-bar">
              <div class="progress-value" style="width: ${percentage}%"></div>
            </div>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    // Update traffic sources chart
    function updateTrafficSourcesChart(sources) {
      if (trafficSourcesChart) {
        trafficSourcesChart.destroy();
      }
      
      try {
        const ctx = document.getElementById('trafficSourcesChart').getContext('2d');
        
        // Calculate total for percentage
        const total = sources.reduce((sum, source) => sum + source.count, 0);
        
        trafficSourcesChart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: sources.map(source => source.name),
            datasets: [{
              data: sources.map(source => source.count),
              backgroundColor: [
                'rgba(20, 184, 166, 0.8)',
                'rgba(6, 95, 70, 0.8)',
                'rgba(52, 211, 153, 0.8)',
                'rgba(16, 185, 129, 0.8)',
                'rgba(24, 150, 120, 0.8)',
                'rgba(10, 120, 100, 0.8)',
                'rgba(30, 170, 140, 0.8)',
                'rgba(40, 190, 160, 0.8)',
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.raw || 0;
                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    return `${label}: ${value} (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      } catch (error) {
        console.error("Error updating traffic sources chart:", error);
        document.getElementById('trafficSourcesChart').parentNode.innerHTML = 
          '<div class="flex items-center justify-center h-40 bg-gray-50 rounded">' +
          '<p class="text-gray-500">Could not load traffic sources data</p>' +
          '</div>';
      }
    }

    // Update geographical heatmap
    function updateGeoMap(locations) {
      if (!map) {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 4,
          center: { lat: 27.9506, lng: -82.4572 }, // Center on Florida
          mapTypeId: 'terrain'
        });
      }
      
      if (heatmap) {
        heatmap.setMap(null);
      }
      
      const heatmapData = locations.map(loc => {
        return {
          location: new google.maps.LatLng(loc.lat, loc.lng),
          weight: loc.weight
        };
      });
      
      heatmap = new google.maps.visualization.HeatmapLayer({
        data: heatmapData,
        map: map,
        radius: 20
      });
    }

    // Update traffic trend chart
    function updateTrafficTrendChart(dailyData) {
      if (trafficTrendChart) {
        trafficTrendChart.destroy();
      }
      
      const ctx = document.getElementById('trafficTrendChart').getContext('2d');
      trafficTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dailyData.map(item => item.date),
          datasets: [{
            label: 'Daily Visitors',
            data: dailyData.map(item => item.visitors),
            borderColor: 'rgba(20, 184, 166, 1)',
            backgroundColor: 'rgba(20, 184, 166, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              },
              ticks: {
                maxTicksLimit: 10
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                borderDash: [2],
                color: 'rgba(0, 0, 0, 0.1)'
              }
            }
          }
        }
      });
    }

    // Update device types
    function updateDeviceTypes(devices) {
      const container = document.getElementById('deviceTypes');
      container.innerHTML = '';
      
      devices.forEach(device => {
        const divElement = document.createElement('div');
        divElement.classList.add('my-4');
        const count = Math.round(device.count || (device.value / 100 * getTotalCount(devices)));
        divElement.innerHTML = `
          <div class="flex items-center justify-between bg-gray-100 px-3 py-2 rounded">
            <span class="text-gray-700">${device.name}</span>
            <span class="font-medium">${count} (${device.value.toFixed(1)}%)</span>
          </div>
          <div class="progress-bar mt-1">
            <div class="progress-value bg-teal-700" style="width: ${device.value}%"></div>
          </div>
        `;
        container.appendChild(divElement);
      });
    }

    // Helper function to calculate total count if needed
    function getTotalCount(items) {
      if (items.some(item => item.count)) {
        return items.reduce((sum, item) => sum + (item.count || 0), 0);
      }
      return 100; // default divisor for percentage-based data
    }

    // Update browsers
    function updateBrowsers(browsers) {
      const container = document.getElementById('browsers');
      container.innerHTML = '';
      
      browsers.forEach(browser => {
        const divElement = document.createElement('div');
        divElement.classList.add('my-4');
        const count = Math.round(browser.count || (browser.value / 100 * getTotalCount(browsers)));
        divElement.innerHTML = `
          <div class="flex items-center justify-between bg-gray-100 px-3 py-2 rounded">
            <span class="text-gray-700">${browser.name}</span>
            <span class="font-medium">${count} (${browser.value.toFixed(1)}%)</span>
          </div>
          <div class="progress-bar mt-1">
            <div class="progress-value bg-teal-700" style="width: ${browser.value}%"></div>
          </div>
        `;
        container.appendChild(divElement);
      });
    }

    // Update referrers
    function updateReferrers(referrers) {
      const tableBody = document.getElementById('topReferrers');
      tableBody.innerHTML = '';
      
      referrers.forEach(referrer => {
        const row = document.createElement('tr');
        row.classList.add('border-b', 'border-gray-100');
        row.innerHTML = `
          <td class="py-3">${referrer.name}</td>
          <td class="text-right py-3">${referrer.sessions}</td>
        `;
        tableBody.appendChild(row);
      });
    }
    
    // Update active users section
    function updateActiveUsers(activeUsers = []) {
      const activeUserCount = document.getElementById('activeUserCount');
      const activeUsersTable = document.getElementById('activeUsers');
      
      // Update count
      activeUserCount.textContent = activeUsers.length;
      
      // Update table
      activeUsersTable.innerHTML = '';
      
      if (activeUsers.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="3" class="text-center py-4">No active users currently.</td>`;
        activeUsersTable.appendChild(row);
      } else {
        activeUsers.forEach(user => {
          const row = document.createElement('tr');
          row.classList.add('border-b', 'border-gray-100');
          
          // Format time difference
          const lastActivity = new Date(user.lastActivity);
          const now = new Date();
          const diffSeconds = Math.floor((now - lastActivity) / 1000);
          let timeAgo;
          
          if (diffSeconds < 60) {
            timeAgo = `${diffSeconds} sec ago`;
          } else if (diffSeconds < 3600) {
            timeAgo = `${Math.floor(diffSeconds / 60)} min ago`;
          } else {
            timeAgo = `${Math.floor(diffSeconds / 3600)} hr ago`;
          }
          
          row.innerHTML = `
            <td class="py-3">${user.name || 'Anonymous'}</td>
            <td class="py-3">${user.currentPage}</td>
            <td class="text-right py-3">${timeAgo}</td>
          `;
          activeUsersTable.appendChild(row);
        });
      }
    }
    
    // Initialize user journey visualization
    function initUserJourneyTabs() {
      // Get tab elements
      const pathTransitionsBtn = document.getElementById('pathTransitionsBtn');
      const entryPagesBtn = document.getElementById('entryPagesBtn');
      const exitPagesBtn = document.getElementById('exitPagesBtn');
      
      // Set up click handlers
      // Store a reference to the current journey data
      let currentJourneyData = null;
      
      pathTransitionsBtn.addEventListener('click', () => {
        setActiveJourneyTab(pathTransitionsBtn);
        if (currentJourneyData) {
          updateUserJourneyVisualization('pathTransitions', currentJourneyData.pathTransitions);
        }
      });
      
      entryPagesBtn.addEventListener('click', () => {
        setActiveJourneyTab(entryPagesBtn);
        if (currentJourneyData) {
          updateUserJourneyVisualization('entryPages', currentJourneyData.entryPages);
        }
      });
      
      exitPagesBtn.addEventListener('click', () => {
        setActiveJourneyTab(exitPagesBtn);
        if (currentJourneyData) {
          updateUserJourneyVisualization('exitPages', currentJourneyData.exitPages);
        }
      });
      
      // Expose the function to update current journey data
      window.updateJourneyData = (data) => {
        currentJourneyData = data;
        updateUserJourneyVisualization('pathTransitions', data.pathTransitions);
      };
    }
    
    // Set active tab in user journey
    function setActiveJourneyTab(activeTab) {
      // Remove active class from all tabs
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Add active class to selected tab
      activeTab.classList.add('active');
    }
    
    // Update user journey visualization
    function updateUserJourneyVisualization(type, data = null) {
      const container = document.getElementById('userJourneyContainer');
      const noDataMsg = document.getElementById('noJourneyDataMsg');
      const visualization = document.getElementById('userJourneyVisualization');
      
      // If no data, show message
      if (!data || data.length === 0) {
        noDataMsg.classList.remove('hidden');
        visualization.classList.add('hidden');
        return;
      }
      
      // Hide message, show visualization
      noDataMsg.classList.add('hidden');
      visualization.classList.remove('hidden');
      
      // Clear previous content
      visualization.innerHTML = '';
      
      // Render visualization based on type
      if (type === 'pathTransitions') {
        renderPathTransitions(visualization, data);
      } else if (type === 'entryPages' || type === 'exitPages') {
        renderPageBreakdown(visualization, data, type);
      }
    }
    
    // Fetch active users data
    function fetchActiveUsers() {
      // Simulate active users for now
      // In a real implementation, this would fetch from a real-time endpoint
      updateActiveUsers([
        {
          name: 'michael',
          currentPage: '/calendar',
          lastActivity: new Date(Date.now() - 45000) // 45 seconds ago
        },
        {
          name: 'Anonymous',
          currentPage: '/forum',
          lastActivity: new Date(Date.now() - 90000) // 90 seconds ago
        }
      ]);
      
      // For real-time updates, you would poll the server every X seconds
      setTimeout(fetchActiveUsers, 30000); // Poll every 30 seconds
    }

    // Update date labels
    function updateDateLabels(range) {
      let label = '';
      
      if (range === 1) {
        label = 'Today';
      } else if (range === 7) {
        label = 'Last 7 days';
      } else if (range === 30) {
        label = 'Last 30 days';
      } else if (range === 90) {
        label = 'Last 90 days';
      } else if (range === 365) {
        label = 'Last year';
      } else if (range === 'all') {
        label = 'All time';
      } else {
        label = 'Custom range';
      }
      
      document.getElementById('totalSessionsLabel').textContent = label;
      document.getElementById('uniqueUsersLabel').textContent = label;
    }

    // Store map markers and data for filtering
    let mapMarkers = [];
    let allGeoLocations = [];
    
    // Update geographical map with markers and filters
    function updateGeoMap(locations) {
      // Store original data for filtering
      allGeoLocations = locations;
      
      // Wait until Google Maps is loaded
      if (typeof google === 'undefined' || typeof google.maps === 'undefined' || 
          typeof google.maps.visualization === 'undefined') {
        console.log('Google Maps not yet loaded, will retry');
        
        // Show loading state
        document.getElementById('map').innerHTML = 
          '<div class="flex items-center justify-center h-full bg-gray-100 rounded">' +
          '<p class="text-gray-500">Loading map...</p>' + 
          '</div>';
          
        // Add map filters container
        if (!document.getElementById('mapFilters')) {
          const filtersContainer = document.createElement('div');
          filtersContainer.id = 'mapFilters';
          filtersContainer.className = 'flex flex-wrap gap-2 mt-2 mb-3';
          filtersContainer.innerHTML = `
            <p class="text-sm text-gray-500 mr-2">Filter by:</p>
            <div class="map-filter-controls"></div>
          `;
          document.getElementById('map').parentNode.insertBefore(
            filtersContainer, 
            document.getElementById('map')
          );
        }
          
        // Set a flag to update map later
        window.pendingMapLocations = locations;
        return;
      }
      
      if (!map) {
        try {
          map = new google.maps.Map(document.getElementById('map'), {
            zoom: 4,
            center: { lat: 27.9506, lng: -82.4572 }, // Center on Florida
            mapTypeId: 'terrain'
          });
          
          // Create info window for markers
          window.infoWindow = new google.maps.InfoWindow();
          
          // Add map filters container if not exists
          if (!document.getElementById('mapFilters')) {
            const filtersContainer = document.createElement('div');
            filtersContainer.id = 'mapFilters';
            filtersContainer.className = 'flex flex-wrap gap-2 mt-2 mb-3';
            filtersContainer.innerHTML = `
              <p class="text-sm text-gray-500 mr-2">Filter by:</p>
              <div class="map-filter-controls"></div>
            `;
            document.getElementById('map').parentNode.insertBefore(
              filtersContainer, 
              document.getElementById('map')
            );
          }
          
          // Initialize map view selector
          initMapViewSelector();
        } catch (e) {
          console.error('Error creating Google Map:', e);
          document.getElementById('map').innerHTML = 
            '<div class="flex items-center justify-center h-full bg-gray-100 rounded">' +
            '<p class="text-gray-500">Error loading map. Please try again later.</p>' + 
            '</div>';
          return;
        }
      }
      
      // Clear existing markers
      clearMapMarkers();
      
      // Also clear heatmap if it exists
      if (heatmap) {
        heatmap.setMap(null);
        heatmap = null;
      }
      
      try {
        // Create markers for each location
        mapMarkers = locations.map(loc => {
          // Create marker
          const pagePath = document.getElementById('pageFilter')?.value;
          let markerOptions = {
            position: { lat: loc.lat, lng: loc.lng },
            map: map,
            title: `${loc.city}, ${loc.country}`
          };
          
          // If we're highlighting a specific page and this visitor viewed it, use a custom marker
          if (pagePath && loc.pages && loc.pages.some(page => page.path === pagePath)) {
            markerOptions.icon = {
              path: google.maps.SymbolPath.CIRCLE,
              fillColor: '#14b8a6', // Teal color
              fillOpacity: 0.8,
              scale: 8,
              strokeColor: '#fff',
              strokeWeight: 2
            };
          }
          
          const marker = new google.maps.Marker(markerOptions);
          
          // Add click listener to show info window with detailed visitor information
          marker.addListener('click', () => {
            // Build visited pages list for info window
            let pagesHtml = '';
            if (loc.pages && loc.pages.length > 0) {
              const pagePath = document.getElementById('pageFilter')?.value;
              pagesHtml = `
                <div class="mt-2 pt-2 border-t">
                  <p class="font-medium mb-1">Pages Visited:</p>
                  <ul class="text-xs text-gray-600 space-y-1 ml-2">
                    ${loc.pages.map(page => `
                      <li class="${pagePath === page.path ? 'text-teal-700 font-medium' : ''}">
                        ${page.title}
                      </li>
                    `).join('')}
                  </ul>
                </div>
              `;
            }
            
            const content = `
              <div class="p-3">
                <h3 class="font-bold text-teal-700">${loc.city || 'Unknown'}, ${loc.country || 'Unknown'}</h3>
                ${loc.region ? `<p class="text-sm text-gray-600 mb-2">${loc.region}</p>` : ''}
                <div class="mt-2 border-t pt-2">
                  <p class="text-sm"><span class="font-medium">Sessions:</span> ${loc.sessions || 0}</p>
                  <p class="text-sm"><span class="font-medium">Device:</span> ${loc.device || 'Unknown'}</p>
                  <p class="text-sm"><span class="font-medium">Browser:</span> ${loc.browser || 'Unknown'}</p>
                  ${loc.ip ? `<p class="text-sm"><span class="font-medium">IP:</span> ${loc.ip}</p>` : ''}
                </div>
                ${pagesHtml}
              </div>
            `;
            
            window.infoWindow.setContent(content);
            window.infoWindow.open(map, marker);
          });
          
          return marker;
        });
        
        // Extract countries for filters
        const countries = [...new Set(locations.map(loc => loc.country).filter(Boolean))];
        
        // Update filter UI
        updateMapFilters(countries);
        
        // Update view based on stored preference
        if (window.currentMapView === 'heatmap') {
          showHeatmapView();
        }
      } catch (e) {
        console.error('Error creating map markers:', e);
      }
    }
    
    // Initialize the map view selector
    function initMapViewSelector() {
      const controls = document.querySelector('.map-filter-controls');
      if (!controls) return;
      
      // Set initial view
      window.currentMapView = 'markers';
      
      // Create view selector
      const viewSelector = document.createElement('div');
      viewSelector.className = 'flex flex-wrap gap-2';
      
      // View type controls
      const viewTypeControls = document.createElement('div');
      viewTypeControls.className = 'flex border rounded overflow-hidden';
      viewTypeControls.innerHTML = `
        <button id="markersViewBtn" class="px-3 py-1 bg-teal-600 text-white text-sm">Markers</button>
        <button id="heatmapViewBtn" class="px-3 py-1 bg-gray-200 text-gray-700 text-sm">Heatmap</button>
      `;
      
      // Filter controls
      const filterControls = document.createElement('div');
      filterControls.className = 'flex gap-2';
      filterControls.innerHTML = `
        <select id="countryFilter" class="text-sm border rounded p-1">
          <option value="">All Countries</option>
        </select>
        <select id="pageFilter" class="text-sm border rounded p-1">
          <option value="">All Pages</option>
        </select>
      `;
      
      viewSelector.appendChild(viewTypeControls);
      viewSelector.appendChild(filterControls);
      
      controls.appendChild(viewSelector);
      
      // Add event listeners
      document.getElementById('markersViewBtn').addEventListener('click', () => {
        document.getElementById('markersViewBtn').className = 'px-3 py-1 bg-teal-600 text-white text-sm';
        document.getElementById('heatmapViewBtn').className = 'px-3 py-1 bg-gray-200 text-gray-700 text-sm';
        window.currentMapView = 'markers';
        showMarkersView();
      });
      
      document.getElementById('heatmapViewBtn').addEventListener('click', () => {
        document.getElementById('markersViewBtn').className = 'px-3 py-1 bg-gray-200 text-gray-700 text-sm';
        document.getElementById('heatmapViewBtn').className = 'px-3 py-1 bg-teal-600 text-white text-sm';
        window.currentMapView = 'heatmap';
        showHeatmapView();
      });
      
      document.getElementById('countryFilter').addEventListener('change', event => {
        const country = event.target.value;
        filterMapByCountry(country);
      });
    }
    
    // Update map filters based on available data
    function updateMapFilters(countries) {
      const countryFilter = document.getElementById('countryFilter');
      if (!countryFilter) return;
      
      // Save current selection
      const currentValue = countryFilter.value;
      
      // Clear existing options except first
      while (countryFilter.options.length > 1) {
        countryFilter.remove(1);
      }
      
      // Add countries as options
      countries.sort().forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        countryFilter.appendChild(option);
      });
      
      // Restore selection if possible
      if (currentValue && countries.includes(currentValue)) {
        countryFilter.value = currentValue;
      }
      
      // Set up page filter if we have page data
      if (window.analyticsData && window.analyticsData.geoData && window.analyticsData.geoData.pages) {
        updatePageFilter(window.analyticsData.geoData.pages);
      }
    }
    
    // Update page filter dropdown
    function updatePageFilter(pages) {
      const pageFilter = document.getElementById('pageFilter');
      if (!pageFilter) return;
      
      // Save current selection
      const currentValue = pageFilter.value;
      
      // Clear existing options except first
      while (pageFilter.options.length > 1) {
        pageFilter.remove(1);
      }
      
      // Add page options sorted by title
      pages
        .sort((a, b) => a.title.localeCompare(b.title))
        .forEach(page => {
          const option = document.createElement('option');
          option.value = page.path;
          option.textContent = page.title;
          pageFilter.appendChild(option);
        });
      
      // Restore selection if possible
      if (currentValue) {
        const exists = Array.from(pageFilter.options).some(option => option.value === currentValue);
        if (exists) {
          pageFilter.value = currentValue;
        }
      }
      
      // Add event listener for page filter
      pageFilter.addEventListener('change', event => {
        filterMapByPage(event.target.value);
      });
    }
    
    // Filter map by page
    function filterMapByPage(pagePath) {
      if (!pagePath) {
        // If no page selected, revert to country filter only
        const country = document.getElementById('countryFilter')?.value || '';
        return filterMapByCountry(country);
      }
      
      // Filter locations by those who visited this page
      let filteredLocations = allGeoLocations.filter(loc => {
        // Check if this visitor visited the selected page
        return loc.pages && loc.pages.some(page => page.path === pagePath);
      });
      
      // Further filter by country if selected
      const country = document.getElementById('countryFilter')?.value;
      if (country) {
        filteredLocations = filteredLocations.filter(loc => loc.country === country);
      }
      
      // Update map with filtered locations
      updateMapWithFilteredLocations(filteredLocations, pagePath);
    }
    
    // Filter map by country
    function filterMapByCountry(country) {
      // If no country selected, show all locations
      let filteredLocations = allGeoLocations;
      
      if (country) {
        filteredLocations = allGeoLocations.filter(loc => loc.country === country);
      }
      
      // Check if page filter is also active
      const pagePath = document.getElementById('pageFilter')?.value;
      if (pagePath) {
        filteredLocations = filteredLocations.filter(loc => {
          return loc.pages && loc.pages.some(page => page.path === pagePath);
        });
      }
      
      // Update map with filtered locations
      updateMapWithFilteredLocations(filteredLocations);
    }
    
    // Update map with filtered locations
    function updateMapWithFilteredLocations(filteredLocations, highlightedPage) {
      // Clear existing markers
      clearMapMarkers();
      
      // Clear heatmap if it exists
      if (heatmap) {
        heatmap.setMap(null);
        heatmap = null;
      }
      
      // Create new markers
      mapMarkers = filteredLocations.map(loc => {
        // Determine marker style based on whether this visitor viewed the highlighted page
        let markerOptions = {
          position: { lat: loc.lat, lng: loc.lng },
          map: map,
          title: `${loc.city}, ${loc.country}`
        };
        
        // If we're highlighting a specific page and this visitor viewed it, use a custom marker
        if (highlightedPage && loc.pages && loc.pages.some(page => page.path === highlightedPage)) {
          markerOptions.icon = {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: '#14b8a6', // Teal color
            fillOpacity: 0.8,
            scale: 8,
            strokeColor: '#fff',
            strokeWeight: 2
          };
        }
        
        const marker = new google.maps.Marker(markerOptions);
        
        // Build visited pages list for info window
        let pagesHtml = '';
        if (loc.pages && loc.pages.length > 0) {
          pagesHtml = `
            <div class="mt-2 pt-2 border-t">
              <p class="font-medium mb-1">Pages Visited:</p>
              <ul class="text-xs text-gray-600 space-y-1 ml-2">
                ${loc.pages.map(page => `
                  <li class="${highlightedPage === page.path ? 'text-teal-700 font-medium' : ''}">
                    ${page.title}
                  </li>
                `).join('')}
              </ul>
            </div>
          `;
        }
        
        // Add click listener to show info window
        marker.addListener('click', () => {
          const content = `
            <div class="p-3">
              <h3 class="font-bold text-teal-700">${loc.city || 'Unknown'}, ${loc.country || 'Unknown'}</h3>
              ${loc.region ? `<p class="text-sm text-gray-600 mb-2">${loc.region}</p>` : ''}
              <div class="mt-2 border-t pt-2">
                <p class="text-sm"><span class="font-medium">Sessions:</span> ${loc.sessions || 0}</p>
                <p class="text-sm"><span class="font-medium">Device:</span> ${loc.device || 'Unknown'}</p>
                <p class="text-sm"><span class="font-medium">Browser:</span> ${loc.browser || 'Unknown'}</p>
                ${loc.ip ? `<p class="text-sm"><span class="font-medium">IP:</span> ${loc.ip}</p>` : ''}
              </div>
              ${pagesHtml}
            </div>
          `;
          
          window.infoWindow.setContent(content);
          window.infoWindow.open(map, marker);
        });
        
        return marker;
      });
      
      // Update view based on stored preference
      if (window.currentMapView === 'heatmap') {
        showHeatmapView();
      }
      
      // Adjust map bounds if there are markers
      if (mapMarkers.length > 0) {
        const bounds = new google.maps.LatLngBounds();
        mapMarkers.forEach(marker => {
          bounds.extend(marker.getPosition());
        });
        map.fitBounds(bounds);
      }
    }
    
    // Show markers view
    function showMarkersView() {
      // Hide heatmap if it exists
      if (heatmap) {
        heatmap.setMap(null);
      }
      
      // Show all markers
      mapMarkers.forEach(marker => {
        marker.setMap(map);
      });
    }
    
    // Show heatmap view
    function showHeatmapView() {
      // Hide all markers
      mapMarkers.forEach(marker => {
        marker.setMap(null);
      });
      
      // Get filtered locations
      const country = document.getElementById('countryFilter')?.value;
      const pagePath = document.getElementById('pageFilter')?.value;
      let filteredLocations = allGeoLocations;
      
      // Apply country filter
      if (country) {
        filteredLocations = filteredLocations.filter(loc => loc.country === country);
      }
      
      // Apply page filter
      if (pagePath) {
        filteredLocations = filteredLocations.filter(loc => {
          return loc.pages && loc.pages.some(page => page.path === pagePath);
        });
      }
      
      // Create heatmap
      try {
        const heatmapData = filteredLocations.map(loc => {
          // If we have a page filter, increase weight for visitors who viewed that page
          let weight = loc.weight;
          if (pagePath && loc.pages && loc.pages.some(page => page.path === pagePath)) {
            weight = Math.min(1, weight * 1.5); // Boost weight but cap at 1
          }
          
          return {
            location: new google.maps.LatLng(loc.lat, loc.lng),
            weight: weight
          };
        });
        
        if (heatmap) {
          heatmap.setMap(null);
        }
        
        heatmap = new google.maps.visualization.HeatmapLayer({
          data: heatmapData,
          map: map,
          radius: 20
        });
      } catch (e) {
        console.error('Error creating heatmap:', e);
      }
    }
    
    // Clear all markers from the map
    function clearMapMarkers() {
      mapMarkers.forEach(marker => {
        marker.setMap(null);
      });
      mapMarkers = [];
    }

    // Initialize dashboard
    function initDashboard() {
      console.log('Analytics dashboard loaded');
      
      // Get user info
      getUserInfo();
      
      // Setup date range selectors
      const fromDateInput = document.getElementById('fromDate');
      const toDateInput = document.getElementById('toDate');
      
      // Set default dates (last 30 days)
      const today = new Date();
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(today.getDate() - 30);
      
      fromDateInput.valueAsDate = thirtyDaysAgo;
      toDateInput.valueAsDate = today;
      
      // Add event listeners for date presets
      document.querySelectorAll('.date-preset').forEach(btn => {
        btn.addEventListener('click', () => {
          const days = parseInt(btn.dataset.days);
          currentRange = days;
          fetchAnalyticsData(days);
          
          // Update date inputs to match preset
          const end = new Date();
          const start = new Date();
          start.setDate(end.getDate() - days);
          
          fromDateInput.valueAsDate = start;
          toDateInput.valueAsDate = end;
        });
      });
      
      // Apply button event listener
      document.getElementById('applyDates').addEventListener('click', () => {
        // For custom date ranges, we'll just use 30 days as a placeholder
        // In a real implementation, you'd calculate the actual difference and send it
        fetchAnalyticsData(30);
        currentRange = 'custom';
        updateDatePresets('');
      });
      
      // Fetch initial data
      fetchAnalyticsData();
      
      // Load Google Maps with API key
      checkAndGetGoogleMapsApiKey();
      
      // Initialize active users polling
      fetchActiveUsers();
      
      // Initialize user journey tabs
      initUserJourneyTabs();
    }
    
    // Get Google Maps API key from server endpoint
    function checkAndGetGoogleMapsApiKey() {
      fetch('/api/analytics/status')
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            console.log('Analytics API is operational');
            
            // Get Google Maps API key from server config
            if (result.config && result.config.googleMapsApiKey) {
              window.GOOGLE_MAPS_API_KEY = result.config.googleMapsApiKey;
            } else {
              console.warn('No Google Maps API key provided by server');
              window.GOOGLE_MAPS_API_KEY = 'AIzaSyCM2haREcrosVbf2i6USzCtE624PIxaphs';
            }
            
            loadGoogleMapsApi();
            
            // Set up periodic check for Google Maps loading
            checkGoogleMapsLoaded();
          }
        })
        .catch(error => {
          console.error('Error checking analytics API status:', error);
          // Still try to load maps even if status check fails
          window.GOOGLE_MAPS_API_KEY = '';
          loadGoogleMapsApi();
        });
    }
    
    // Check if Google Maps has loaded
    function checkGoogleMapsLoaded() {
      const maxAttempts = 10;
      let attempts = 0;
      
      const checkInterval = setInterval(() => {
        attempts++;
        if (typeof google !== 'undefined' && typeof google.maps !== 'undefined' && 
            typeof google.maps.visualization !== 'undefined') {
          console.log('Google Maps loaded successfully');
          clearInterval(checkInterval);
          
          // If we have pending data, update the map now
          if (window.pendingMapLocations) {
            updateGeoMap(window.pendingMapLocations);
            window.pendingMapLocations = null;
          }
        } else if (attempts >= maxAttempts) {
          console.error('Failed to load Google Maps after multiple attempts');
          clearInterval(checkInterval);
          
          // Show error in map container
          document.getElementById('map').innerHTML = 
            '<div class="flex items-center justify-center h-full bg-gray-100 rounded">' +
            '<p class="text-gray-500">Map service unavailable</p>' + 
            '</div>';
        }
      }, 1000);
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      initDashboard();
    });
    
    // Render a path transitions diagram
    function renderPathTransitions(container, data) {
      // Create a simple flow diagram
      const html = `
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead>
              <tr>
                <th class="text-left py-2">Source Page</th>
                <th class="text-left py-2">Target Page</th>
                <th class="text-right py-2">Transitions</th>
              </tr>
            </thead>
            <tbody>
              ${data.map(item => `
                <tr class="border-b border-gray-100">
                  <td class="py-2">${item.source}</td>
                  <td class="py-2">
                    <svg class="inline-block w-4 h-4 mx-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    ${item.target}
                  </td>
                  <td class="text-right py-2">
                    ${item.value}
                    <div class="progress-bar mt-1">
                      <div class="progress-value" style="width: ${Math.min(100, item.value * 5)}%"></div>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    // Render a page breakdown (entry or exit pages)
    function renderPageBreakdown(container, data, type) {
      // Calculate the maximum value for percentage calculation
      const maxValue = Math.max(...data.map(item => item.count));
      
      const title = type === 'entryPages' ? 'Entry Pages' : 'Exit Pages';
      const description = type === 'entryPages' 
        ? 'The pages visitors first land on when visiting your site'
        : 'The last pages visitors view before leaving your site';
      
      const html = `
        <div>
          <p class="text-sm text-gray-500 mb-4">${description}</p>
          <div class="space-y-4">
            ${data.map(item => {
              const percentage = maxValue > 0 ? (item.count / maxValue * 100) : 0;
              return `
                <div class="flex items-center justify-between">
                  <div class="w-2/3">
                    <div class="font-medium">${item.page}</div>
                    <div class="progress-bar mt-1">
                      <div class="progress-value" style="width: ${percentage}%"></div>
                    </div>
                  </div>
                  <div class="w-1/3 text-right">
                    <span class="font-medium">${item.count}</span>
                    <span class="text-gray-500 ml-1">visits</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }
  </script>
</body>
</html>